# Maintainer: Sam Mulvey (Refutationalist) <archlinux@sammulvey.com>


# Build Options
# I'm not going to lie, this is three packages in a coat.
_build_pvh=${build_pvh:-true}
_build_pv32=${build_pv32:-false}
_build_pv64=${build_pv64:-true}


pkgbase=xen-grub
pkgver=2.12.r97.g1763d83
pkgrel=1
pkgdesc="a version of GRUB2 for booting Xen PVH domUs"
arch=(x86_64)
url="https://www.gnu.org/software/grub/"
license=(GPL3)
makedepends=(git xz python texinfo gettext device-mapper)
depends=(xen)
options=(!buildflags !strip)

# Okay, what packages am I building?
pkgname=()
[ "${_build_pvh}"  == "true" ] && pkgname+=("xen-grub-pvh")
[ "${_build_pv32}" == "true" ] && pkgname+=("xen-grub-pv32")
[ "${_build_pv64}" == "true" ] && pkgname+=("xen-grub-pv64")



source=(
	"git+https://git.savannah.gnu.org/git/grub.git"
	"git+https://git.savannah.gnu.org/git/gnulib.git"
	"grub.cfg")
sha512sums=('SKIP'
            'SKIP'
            '538ec7d6e33baaf7d1c708ed1ae6313691a04c331fd7d2cc2b47f56f2b5c218c75081b20204be68934bf88b6497b937917555424e3a379e12a481921093d7ce8')


pkgver() {
	cd "${srcdir}/grub"
	git describe --long --abbrev=7 | sed 's/^grub-//;s/\([^-]*-g\)/r\1/;s/-/./g'
	
}


prepare() {
	cd "$srcdir/grub"
	./bootstrap  \
		--gnulib-srcdir="${srcdir}/gnulib/" \
		--no-git
	cp "${srcdir}/grub.cfg" .

	cd ..
	echo "dividing source trees"
	[ "${_build_pvh}"  == "true" ] && cp -R grub grub-pvh
	[ "${_build_pv32}" == "true" ] && cp -R grub grub-pv32
	[ "${_build_pv64}" == "true" ] && cp -R grub grub-pv64
}

build() {
	cd "${srcdir}"

	if [ "${_build_pvh}" == "true" ]; then

		echo "--> Building PVH"

		cd grub-pvh

		TARGET_LDFLAGS=-static ./configure \
			--with-platform=xen_pvh \
			--enable-device-mapper

		# this will compile a ton of stuff we'll never, ever need.
		make

		# make the bootloader image
		./grub-mkstandalone \
			--grub-mkimage=./grub-mkimage \
			-o pvhgrub \
			-O i386-xen_pvh \
			-d ./grub-core/ "/boot/grub/grub.cfg=./grub.cfg"

		cd ..
	fi

	if [ "${_build_pv32}" == "true" ]; then

		echo "--> Building PV32"

		cd "${srcdir}/grub-pv32"

		TARGET_LDFLAGS=-static ./configure \
			--target=i386 \
			--with-platform=xen \
			--enable-device-mapper

		make

		./grub-mkstandalone \
			--grub-mkimage=./grub-mkimage \
			-o pvgrub32 \
			-O i386-xen \
			-d ./grub-core/ "/boot/grub/grub.cfg=./grub.cfg" \
			--locale-directory=/usr/share/locale

		cd ..


	fi

	if [ "${_build_pv64}" == "true" ]; then
		
		echo "--> Building PV64"

		cd "${srcdir}/grub-pv64"

		TARGET_LDFLAGS=-static ./configure \
			--target=amd64 \
			--with-platform=xen \
			--enable-device-mapper

		make

		./grub-mkstandalone \
			--grub-mkimage=./grub-mkimage \
			-o pvgrub64 \
			-O x86_64-xen \
			-d ./grub-core/ "/boot/grub/grub.cfg=./grub.cfg" \
			--locale-directory=/usr/share/locale

		cd ..


	fi


}

package_xen-grub-pvh() {
	pkgdesc="GRUB bootloader for Xen PVH domUs"
	provides=(xen-pvhgrub)
	conflicts=(xen-pvhgrub)

	cd "$srcdir/${_srcname}"
	mkdir -p "${pkgdir}/usr/lib/xen/boot"
	install -m644 "${srcdir}/grub-pvh/pvhgrub" "${pkgdir}/usr/lib/xen/boot"

}

package_xen-grub-pv32() {
	pkgdesc="GRUB bootloader for Xen 32bit domUs"

	cd "$srcdir/${_srcname}"
	mkdir -p "${pkgdir}/usr/lib/xen/boot"
	install -m644 "${srcdir}/grub-pv32/pvgrub32" "${pkgdir}/usr/lib/xen/boot"

}

package_xen-grub-pv64() {
	pkgdesc="GRUB bootloader for Xen 64bit domUs"

	cd "$srcdir/${_srcname}"
	mkdir -p "${pkgdir}/usr/lib/xen/boot"
	install -m644 "${srcdir}/grub-pv64/pvgrub64" "${pkgdir}/usr/lib/xen/boot"

}


